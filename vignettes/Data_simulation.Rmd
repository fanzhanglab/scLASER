---
title: "scLASER • Data Simulation (2, 3, and 5 Time Points)"
author: |
  fanzhang labs  
  [Lab Website - https://fanzhanglab.org](https://fanzhanglab.org)  
  [Lab GitHub - https://github.com/fanzhanglab](https://github.com/fanzhanglab)
date: "`r format(Sys.Date())`"
output:
  rmarkdown::html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    code_folding: show
    theme:
      version: 5
      bootswatch: flatly
      primary: "#984EA3"
      base_font: {google: "Inter"}
      heading_font: {google: "Inter"}
      code_font: {google: "Fira Code"}
vignette: >
  %\VignetteIndexEntry{scLASER • Data Simulation (2, 3, 5 TP)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

> This vignette covers **data simulation only** and **cell-type proportion plots**.  
> • For **≤ 3 time points**, use `plot_celltype_proportions()` (built-in).  
> • For **≥ 4 time points**, we show **plain ggplot code** to plot **by cell type**.

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment  = "#>",
  warning  = FALSE,
  message  = FALSE,
  fig.width  = 7.2,
  fig.height = 4.8
)
```

```{r}
library(scLASER)
library(dplyr)
library(tidyr)
library(ggplot2)
```

# 1. How visit effects control the simulation

The three arguments below **jointly control** how interacting cell types evolve across visits and differ between groups:

- `visit_effects_progressor` — a numeric **vector of length = time_points** giving per-visit **proportional changes** for **disease = 1** (progressors). Example: `c(0.00, 0.30)` means no change at V0 and **+30%** at V1. Negative values decrease abundance.
- `visit_effects_control` — same structure for **disease = 0** (controls). Often all zeros to represent stability.
- `direction_by_cluster` — a vector of **+1 / −1** (recycled as needed) applied **per interacting cell type**. `+1` means the effect increases abundance; `−1` flips the sign (decrease).

**Example (5 visits):**  
```r
visit_effects_progressor = c(0.00, 0.30, 0.60, 0.20, 0.40)
visit_effects_control    = c(0,    0,    0,    0,    0)
direction_by_cluster     = c(+1, -1, +1, -1)   # recycled across interacting CTs
```

---

# 2. Two Time Points (V0, V1)

```{r}
d2 <- generate_dummy_data(
  n_cells = 150,
  sd_celltypes = 0.1,
  n_major_cell_types = 7,
  n_minor_cell_types = 3,
  relative_abundance = 0.4,
  n_major_interact_celltypes = 2,
  n_minor_interact_celltypes = 2,
  n_individuals = 30,
  n_batchs = 4,
  interaction_feature = "visit",
  time_points = 2,
  test_var = "disease",
  prop_disease = 0.5,
  fc_interact = 0.6,
  interaction_type = "specific",
  seed = 2020,
  visit_effects_progressor = c(0.00, 0.30),
  visit_effects_control    = c(0, 0),
  direction_by_cluster     = c(+1, -1, +1, -1)
)

obj2 <- scLASER(metadata = d2)


plot_celltype_proportions(obj2)
```

---

# 3. Three Time Points (V0, V1, V2)

```{r}
d3 <- generate_dummy_data(
  n_cells = 150,
  sd_celltypes = 0.1,
  n_major_cell_types = 7,
  n_minor_cell_types = 3,
  relative_abundance = 0.4,
  n_major_interact_celltypes = 2,
  n_minor_interact_celltypes = 2,
  n_individuals = 30,
  n_batchs = 4,
  interaction_feature = "visit",
  time_points = 3,
  test_var = "disease",
  prop_disease = 0.5,
  fc_interact = 0.6,
  interaction_type = "specific",
  seed = 2020,
  visit_effects_progressor = c(0.00, 0.30, 0.60),
  visit_effects_control    = c(0, 0, 0),
  direction_by_cluster     = c(+1, -1, +1, -1)
)

obj3 <- scLASER(metadata = d3)

plot_celltype_proportions(obj3)
```

---

# 4. Five Time Points (Manual plotting by cell type)

For ≥ 4 visits the code below uses **plain ggplot** to plot one panel **per cell type**:  
light lines = individual subjects; bold line + points = group mean; ribbon = 95% CI.

```{r}
d5 <- generate_dummy_data(
  n_cells = 150,
  sd_celltypes = 0.1,
  n_major_cell_types = 7,
  n_minor_cell_types = 3,
  relative_abundance = 0.4,
  n_major_interact_celltypes = 2,
  n_minor_interact_celltypes = 2,
  n_individuals = 30,
  n_batchs = 4,
  interaction_feature = "visit",
  time_points = 5,
  test_var = "disease",
  prop_disease = 0.5,
  fc_interact = 0.6,
  interaction_type = "specific",
  seed = 2020,
  visit_effects_progressor = c(0.00, 0.30, 0.60, 0.20, 0.40),
  visit_effects_control    = c(0, 0, 0, 0, 0),
  direction_by_cluster     = c(+1, -1, +1, -1)
)

obj5 <- scLASER(metadata = d5)
```

## 4.1 Helper to compute per-cell-type proportions

```{r}
prep_prop_data <- function(obj, cell_type = "A") {
  md <- obj@metadata
  md$disease <- factor(md$disease, levels = c(0,1), labels = c("Control","Disease"))

  totals <- md %>%
    count(subject_id, visit, disease, name = "n_total")

  ct_counts <- md %>%
    dplyr::filter(cell_type == .env$cell_type) %>%
    count(subject_id, visit, disease, name = "n_ct")

  df <- totals %>%
    left_join(ct_counts, by = c("subject_id","visit","disease")) %>%
    mutate(n_ct = replace_na(n_ct, 0L),
           prop = n_ct / n_total)

  df_sum <- df %>%
    group_by(disease, visit) %>%
    summarise(
      mean_prop = mean(prop, na.rm = TRUE),
      se        = sd(prop, na.rm = TRUE) / sqrt(dplyr::n()),
      ymin      = mean_prop - 1.96 * se,
      ymax      = mean_prop + 1.96 * se,
      .groups   = "drop"
    )

  list(indiv = df, summary = df_sum)
}
```

## 4.2 Plot one cell type 

```{r}
plot_ct_manual <- function(obj, cell_type = "A") {
  dd <- prep_prop_data(obj, cell_type = cell_type)
  df <- dd$indiv
  df_sum <- dd$summary

  ggplot(df, aes(x = visit, y = prop, group = subject_id, color = disease)) +
    geom_line(alpha = 0.25) +
    geom_line(data = df_sum,
              aes(x = visit, y = mean_prop, group = disease, color = disease),
              linewidth = 1.2) +
    geom_point(data = df_sum,
               aes(x = visit, y = mean_prop, group = disease, color = disease),
               size = 2) +
    geom_ribbon(data = df_sum,
                aes(x = visit, ymin = ymin, ymax = ymax, fill = disease),
                alpha = 0.12, inherit.aes = FALSE, colour = NA) +
    scale_x_continuous(breaks = sort(unique(df$visit))) +
    labs(x = "Visit",
         y = paste0("Proportion of cell type ", cell_type),
         color = "Group", fill = "Group",
         title = paste("Trajectory — Cell type", cell_type)) +
    theme_bw() +
    theme(panel.grid = element_blank(),
          plot.title = element_text(face = "bold"))
}
```

## 4.3 Plot all cell types (loop)

```{r}
cts <- sort(unique(obj5@metadata$cell_type))
for (ct in cts) {
  print(plot_ct_manual(obj5, cell_type = ct))
}
```

---

# 5. (Optional) Generate pseudo-PCs

`generate_pseudo_pcs_time()` creates a synthetic PC matrix reflecting chosen sources of variation (cluster, batch, visit, interaction, etc.). This resembles real PC structure but with **known ground truth**, useful for method development.

```{r}
pcs_matrix <- generate_pseudo_pcs_time(
  d3,
  n_pcs = 20,
  cluster_pcs = 1:20,
  disease_pcs = 0,
  sex_pcs = 0,
  age_pcs = 0,
  bmi_pcs = 0,
  batch_pcs = 0,
  interaction_pcs = 0,
  visit_pcs = 0,
  subject_pcs = 0,
  cluster_ratio = 0.8,
  disease_ratio = 0,
  sex_ratio = 0,
  age_ratio = 0,
  bmi_ratio = 0,
  batch_ratio = 0,
  interaction_ratio = 0,
  visit_ratio = 0,
  subject_ratio = 0,
  scale_factor = 5,
  cluster_col = "cell_type",
  sex_col = "sex",
  age_col = "age",
  bmi_col = "bmi",
  batch_col = "batch",
  disease_col = "disease",
  visit_col = "visit",
  seed = 1234
)
dim(pcs_matrix)
```

