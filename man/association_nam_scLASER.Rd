% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/association_nam.R
\name{association_nam_scLASER}
\alias{association_nam_scLASER}
\title{Association testing between NAM embeddings and a sample-level variable}
\usage{
association_nam_scLASER(
  obj,
  seurat_object = NULL,
  test_var = NULL,
  samplem_key = NULL,
  graph_use = "RNA_snn",
  batches = NULL,
  covs = NULL,
  nsteps = NULL,
  verbose = TRUE,
  assay = NULL,
  key = "NAMPC_",
  maxnsteps = 15L,
  max_frac_pcs = 0.15,
  n_pcs = NULL,
  ks = NULL,
  Nnull = 1000,
  force_permute_all = FALSE,
  local_test = TRUE,
  seed = 1234,
  return_nam = TRUE
)
}
\arguments{
\item{obj}{A \code{\linkS4class{scLASER}} object. Must contain either:
(a) a populated \code{@harmony} matrix and \code{@metadata} to internally
construct a Seurat object, or
(b) be accompanied by a non-\code{NULL} \code{seurat_object}.}

\item{seurat_object}{A \code{Seurat} object with a precomputed cell-cell
neighbor graph (e.g. after \code{Seurat::FindNeighbors()}). If \code{NULL},
a minimal Seurat object is constructed internally from \code{obj}.}

\item{test_var}{Character. Name of a numeric sample-level variable to test
for association with NAM embeddings.}

\item{samplem_key}{Character. Column name identifying samples in both
cell-level and sample-level metadata.}

\item{graph_use}{Character. Name of the graph in
\code{seurat_object@graphs} to use. Default \code{"RNA_snn"}.}

\item{batches}{Optional character vector of batch variable names used for
conditional permutation stratification.}

\item{covs}{Optional character vector of covariate names to regress out
before association testing.}

\item{nsteps}{Integer or \code{NULL}. Number of diffusion steps for NAM
construction. If \code{NULL}, an adaptive stopping rule is used.}

\item{verbose}{Logical. Print progress messages.}

\item{assay}{Character or \code{NULL}. Assay name for the created Seurat
reduction.}

\item{key}{Character. Key prefix for the NAM PC reduction.}

\item{maxnsteps}{Integer. Maximum number of diffusion steps when using
adaptive stopping.}

\item{max_frac_pcs}{Numeric in (0,1]. Maximum fraction of samples used to
determine the upper bound on NAM PCs.}

\item{n_pcs}{Integer or \code{NULL}. Explicit number of NAM PCs to use when
constructing the neighbor graph and downstream association tests.}

\item{ks}{Optional integer vector of candidate numbers of NAM PCs to scan
in the min-\emph{p} procedure.}

\item{Nnull}{Integer. Number of conditional permutations.}

\item{force_permute_all}{Logical. If \code{TRUE}, ignore batch structure
during permutations.}

\item{local_test}{Logical. If \code{TRUE}, compute neighborhood-level
empirical FDR thresholds.}

\item{seed}{Integer. Random seed for permutation testing.}

\item{return_nam}{Logical. If \code{TRUE}, store NAM embeddings and related
matrices in the returned object.}
}
\value{
A `Seurat` object where:
\itemize{
  \item `reductions$cna` contains:
    \itemize{
      \item `embeddings`: neighborhood-by-PC NAM embeddings (nbhd x PC)
      \item `loadings`: sample-by-PC NAM loadings
      \item `stdev`: singular values
      \item `misc`: a list with fields: `p` (global p-value), `nullminps`, `k` (selected PCs),
        `ncorrs` (per-cell neighborhood correlations), `fdrs` (data.frame of FDR vs threshold),
        `fdr_5p_t`, `fdr_10p_t`, `yhat`, `ycond`, `ks`, `beta`, `r2`,
        `r2_perpc`, `nullr2_mean`, `nullr2_std`, projection matrix `M` and rank `r`.
    }
  \item `meta.data$cna_ncorrs`: per-cell (neighborhood) correlation score.
  \item `meta.data$cna_ncorrs_fdr05`, `meta.data$cna_ncorrs_fdr10`,
  `meta.data$cna_ncorrs_fdr20`, `meta.data$cna_ncorrs_fdr30`,
  `meta.data$cna_ncorrs_fdr40`, `meta.data$cna_ncorrs_fdr50`:
  thresholded versions at target FDR cutoffs.
}
}
\description{
Computes Neighborhood Aggregation Matrix (NAM) embeddings from a Seurat graph,
residualizes them with respect to optional covariates, performs an SVD to obtain
NAM PCs, and tests association between the NAM subspace and a numeric
sample-level variable via a min-\emph{p} procedure with conditional permutations.
Optionally writes the results back into the Seurat object as a reduction (`cna`)
and per-cell neighborhood correlations (with FDR-thresholded variants).
}
\details{
You can either (a) pass a Seurat object that already has a nearest-neighbor graph
(e.g. created by `Seurat::FindNeighbors()`), or (b) pass `metadata` and precomputed
low-dimensional coordinates (`pcs`), in which case a minimal Seurat object and graph
are built internally.


**Pipeline summary:**\
(1) Build NAM by diffusing sample indicators over the cell graph;\
(2) Batch-kurtosis QC to drop unstable neighborhoods; \
(3) Residualize NAM against covariates; \
(4) SVD to obtain NAM PCs; \
(5) Choose \eqn{k} via a min-\emph{p} scan over candidate `ks`; \
(6) Obtain a global p-value using conditional permutations (stratified by `batches` if provided); \
(7) Optionally compute neighborhood-level empirical FDR thresholds.
}
\section{Requirements}{

Relies on \pkg{Seurat}, \pkg{Matrix}, \pkg{RSpectra}, \pkg{moments}, \pkg{dplyr},
\pkg{tibble}, \pkg{purrr}, and \pkg{glue}. Ensure a neighbor graph exists if supplying
a `Seurat` object (see `Seurat::FindNeighbors()`).
}

\examples{
\dontrun{
# Case A: start from an existing Seurat object with a graph
obj <- Seurat::FindNeighbors(obj, reduction = "pca", dims = 1:20)
obj <- association_nam(
  seurat_object = obj,
  test_var = "numeric_sample_trait",
  samplem_key = "sample_id",
  covs = c("age","sex"),
  batches = "batch",
  graph_use = "RNA_snn",
  local_test = TRUE
)

# Case B: build from metadata + precomputed PCs
obj2 <- association_nam(
  seurat_object = NULL,
  metadata = meta_df,             # rows = samples
  pcs = pcs_mat,                  # rows = samples, cols = PCs
  test_var = "numeric_sample_trait",
  samplem_key = "sample_id",
  local_test = FALSE
)
}

}
\seealso{
\code{\link[Seurat]{FindNeighbors}}, \code{\link[Seurat]{CreateSeuratObject}},
  \code{\link[Seurat]{CreateDimReducObject}}
}
